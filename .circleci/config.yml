version: 2
jobs:
 build:
   docker:
     # using custom image, see .circleci/images/primary/Dockerfile
     - image: docker/compose:1.16.1
   working_directory: /app

   steps:
     - checkout

     - setup_remote_docker

     - run:
         name: Build docker-compose containers
         command: |
           docker-compose build

    #  - run:
    #      name: Start containers
    #      command: |
    #        docker-compose up -d

     - run:
          name: Install awscli
          command: apt-get update && apt-get install -y awscli

     - deploy:
          name: Push application Docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              login="$(aws ecr get-login --region eu-west-1)"
              ${login}
              docker tag app "${ECR_ENDPOINT}/app:${CIRCLE_SHA1}"
              docker push "${ECR_ENDPOINT}/app:${CIRCLE_SHA1}"
            fi